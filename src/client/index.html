<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
	<title>SDR WebViewer (HackRF)</title>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Roboto+Mono&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="style.css">
	<script src="script.js" type="module"></script>
</head>
<body>
	<div id="app" v-cloak>
		<!-- Top Bar -->
		<div class="top-bar">
			<div class="brand">SDR WebViewer</div>
			<div class="vfo-displays">
				<div class="vfo-display"
					v-for="(vfo, i) in vfos" :key="'vfo-disp-' + i"
					:class="{ 'vfo-active': activeVfoIndex === i }"
					@click="activeVfoIndex = i"
					:style="activeVfoIndex === i ? { borderColor: vfoColor(i) } : {}"
					:title="'Click to tune VFO ' + (i + 1)">
					<span class="vfo-label" :style="{ background: vfoColor(i) }">{{ i + 1 }}</span>
					<input class="vfo-freq-input" type="text"
						v-model="vfo.displayFreq"
						@blur="applyVfoFreq($event, i)"
						@keyup.enter="applyVfoFreq($event, i)"
						@focus="focusVfoFreq(i)">
					<div class="vfo-unit">MHz</div>
				</div>
			</div>
			<div class="top-controls">
				<button class="icon-btn" @click="togglePlay" :class="{ active: running }" :disabled="!connected">
					<svg v-if="!running" viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M8 5v14l11-7z"/></svg>
					<svg v-else viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
				</button>
				<button class="icon-btn" @click="showStats = !showStats" :class="{ active: showStats }" title="DSP Stats">
					<svg viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg>
				</button>
				<button class="icon-btn" @click="toggleTranscriptPanel" :class="{ active: whisper.panelOpen }" title="Live Transcription (Whisper AI)">
					<svg viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M12 15c1.66 0 3-1.34 3-3V6c0-1.66-1.34-3-3-3S9 4.34 9 6v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V6zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-2.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
				</button>
			</div>
		</div>

		<div class="main-layout">
			<!-- Sidebar -->
			<div class="sidebar">
				<div class="panel">
					<div class="panel-header">Source</div>
					<div class="panel-body">
						<div class="form-row">
							<button class="btn btn-primary" v-if="!connected" @click="connect">Connect Device</button>
							<button class="btn" v-else @click="disconnect">Disconnect</button>
						</div>
						<div class="form-row info-row" v-if="connected">
							<small>{{ info.boardName }}</small>
						</div>
					</div>
				</div>

				<div class="panel" :class="{ disabled: !connected }">
					<div class="panel-header">Radio</div>
					<div class="panel-body">
						<div class="form-row">
							<label>Center</label>
							<div class="input-group">
								<input type="number" v-model.number="radio.centerFreq" step="0.1" title="Center Frequency (MHz)">
								<span>MHz</span>
							</div>
						</div>
						<div class="form-row">
							<label>Sample Rate</label>
							<select v-model.number="radio.sampleRate">
								<option value="2000000">2 MSPS</option>
								<option value="4000000">4 MSPS</option>
								<option value="8000000">8 MSPS</option>
								<option value="10000000">10 MSPS</option>
								<option value="16000000">16 MSPS</option>
								<option value="20000000">20 MSPS</option>
							</select>
						</div>
						<div class="form-row">
							<label>LNA Gain</label>
							<div class="slider-group">
								<input type="range" v-model.number="gains.lna" min="0" max="40" step="8">
								<span class="val">{{ gains.lna }}dB</span>
							</div>
						</div>
						<div class="form-row">
							<label>VGA Gain</label>
							<div class="slider-group">
								<input type="range" v-model.number="gains.vga" min="0" max="62" step="2">
								<span class="val">{{ gains.vga }}dB</span>
							</div>
						</div>
						<div class="form-row">
							<label class="checkbox">
								<input type="checkbox" v-model="gains.ampEnabled"> Amp (14dB)
							</label>
						</div>
					</div>
				</div>

				<div class="panel" v-for="(vfo, i) in vfos" :key="'vfo-panel-' + i" :class="{ disabled: !connected }">
					<div class="panel-header" style="display: flex; justify-content: space-between; align-items: center;">
						<div style="display: flex; align-items: center; gap: 6px;">
							<span class="vfo-dot" :style="{ background: vfoColor(i) }"></span>
							VFO {{ i + 1 }}
						</div>
						<div style="display: flex; align-items: center; gap: 4px;">
							<button v-if="vfos.length > 1" class="vfo-remove-btn" @click="removeVfo(i)" title="Remove VFO">&times;</button>
							<label class="custom-checkbox header-checkbox">
								<input type="checkbox" v-model="vfo.enabled" @change="toggleVfoCheckbox(i)" :disabled="!running">
								<span class="checkmark"></span>
							</label>
						</div>
					</div>
					<div class="panel-body panel-condensed">
						<div class="mode-grid">
							<label class="mode-radio" v-for="m in ['nfm','am','usb','lsb','wfm','dsb','cw','raw']" :key="m">
								<input type="radio" :value="m" v-model="vfo.mode" :name="'mode-' + i" @change="applyModeDefaults(i)">
								<span class="mode-btn">{{ m.toUpperCase() }}</span>
							</label>
						</div>
						
						<div class="form-row">
							<label style="flex: 0 0 90px;">Bandwidth</label>
							<div class="spin-group">
								<input type="number" v-model.number="vfo.bandwidth" step="1000" :disabled="vfo.mode === 'raw'">
								<button @click="vfo.bandwidth -= 1000" :disabled="vfo.mode === 'raw'">-</button>
								<button @click="vfo.bandwidth += 1000" :disabled="vfo.mode === 'raw'">+</button>
							</div>
						</div>
						
						<div class="form-row">
							<label style="flex: 0 0 90px;">Snap Interval</label>
							<div class="spin-group">
								<input type="number" v-model.number="vfo.snapInterval" step="1000">
								<button @click="vfo.snapInterval -= 1000">-</button>
								<button @click="vfo.snapInterval += 1000">+</button>
							</div>
						</div>

						<div class="form-row" v-if="vfo.mode === 'wfm' || vfo.mode === 'nfm'">
							<label style="flex: 0 0 90px;">De-emphasis</label>
							<select v-model="vfo.deEmphasis" style="width: 130px; margin-left: auto;">
								<option value="none">None</option>
								<option value="22us">22us</option>
								<option value="50us">50us</option>
								<option value="75us">75us</option>
							</select>
						</div>

						<div class="form-row squelch-row">
							<label class="custom-checkbox">
								<input type="checkbox" v-model="vfo.squelchEnabled">
								<span class="checkmark"></span>
								Squelch
							</label>
							<div class="slider-group compact-slider" style="margin-left: 8px;">
								<input type="range" v-model.number="vfo.squelchLevel" min="-100" max="0" step="0.1" :disabled="!vfo.squelchEnabled">
								<span class="val">{{ vfo.squelchLevel.toFixed(3) }}dB</span>
							</div>
						</div>

						<div class="form-row full-checkbox-row" v-if="vfo.mode === 'nfm' || vfo.mode === 'wfm'">
							<label class="custom-checkbox">
								<input type="checkbox" v-model="vfo.noiseReduction">
								<span class="checkmark"></span>
								IF Noise Reduction
							</label>
						</div>

						<div class="form-row full-checkbox-row" v-if="vfo.mode === 'wfm'">
							<label class="custom-checkbox">
								<input type="checkbox" v-model="vfo.stereo">
								<span class="checkmark"></span>
								Stereo
							</label>
						</div>

						<div class="form-row full-checkbox-row" v-if="vfo.mode === 'nfm' || vfo.mode === 'wfm'">
							<label class="custom-checkbox">
								<input type="checkbox" v-model="vfo.lowPass">
								<span class="checkmark"></span>
								Low Pass
							</label>
						</div>

						<div class="form-row full-checkbox-row" v-if="vfo.mode === 'wfm'">
							<label class="custom-checkbox">
								<input type="checkbox" v-model="vfo.rds">
								<span class="checkmark"></span>
								Decode RDS
							</label>
						</div>

						<div class="form-row" v-if="vfo.mode === 'wfm' && vfo.rds" style="align-items: center;">
							<label style="flex: 0 0 120px; opacity: 0.7;">Advanced RDS Info</label>
							<select v-model="vfo.rdsRegion" style="width: 130px; margin-left: auto;">
								<option value="eu">Europe</option>
								<option value="na">North America</option>
							</select>
						</div>
						
						<div class="form-row">
							<label>Volume</label>
							<div class="slider-group">
								<input type="range" v-model.number="vfo.volume" min="0" max="100" step="1">
								<span class="val">{{ vfo.volume }}%</span>
							</div>
						</div>
					</div>
				</div>

				<!-- Add VFO button -->
				<div class="panel" :class="{ disabled: !connected }">
					<div class="panel-body" style="padding: 8px 12px;">
						<button class="btn btn-primary" @click="addVfo">+ Add VFO</button>
					</div>
				</div>
			</div>

			<!-- Canvas Area -->
			<div class="workspace">
				<div class="fft-container" ref="fftContainer">
					<canvas id="fft" ref="fft"></canvas>
					<!-- Canvas Overlay lines -->
					<div class="freq-axis">
						<div class="tick" style="left: 0%">{{ labelFreq(0) }}</div>
						<div class="tick" style="left: 25%">{{ labelFreq(0.25) }}</div>
						<div class="tick" style="left: 50%">{{ labelFreq(0.5) }}</div>
						<div class="tick" style="left: 75%">{{ labelFreq(0.75) }}</div>
						<div class="tick" style="right: 0px">{{ labelFreq(1) }}</div>
					</div>
					<div class="hover-tick" ref="hoverTick" style="display: none">{{ hoverFreqText }}</div>
					<!-- DSP Performance Stats Overlay -->
					<div v-if="showStats && dspStats" class="dsp-stats-overlay">
						<div><b>DSP Stats</b></div>
						<div>USB: {{ dspStats.usbFps }} cb/s | Chunk: {{ dspStats.chunkSize }} B</div>
						<div>DSP: {{ dspStats.dspAvgMs }}ms avg / {{ dspStats.dspMaxMs }}ms max</div>
						<div>Audio: {{ dspStats.audioFps }} calls/s | {{ dspStats.audioRate }} samp/s</div>
						<div>Msgs: {{ dspStats.msgRate }} /s | Input: {{ (dspStats.inputRate/1e6).toFixed(2) }} MSa/s</div>
						<div>Dropped: {{ dspStats.dropped }}</div>
					</div>
				</div>
				<div class="waterfall-container">
					<canvas id="waterfall" ref="waterfall"></canvas>
				</div>
			</div>
		</div>

		<!-- Transcript Panel -->
		<div class="transcript-panel" v-if="whisper.panelOpen">
			<div class="transcript-header">
				<div class="transcript-title">
					<svg viewBox="0 0 24 24" width="16" height="16" style="vertical-align: middle; margin-right: 4px;"><path fill="currentColor" d="M12 15c1.66 0 3-1.34 3-3V6c0-1.66-1.34-3-3-3S9 4.34 9 6v6c0 1.66 1.34 3 3 3z"/></svg>
					Live Transcription
					<span class="transcript-badge" v-if="whisper.status === 'ready'">Ready</span>
					<span class="transcript-badge loading" v-else-if="whisper.status === 'loading'">Loading {{ whisper.loadProgress }}%</span>
					<span class="transcript-badge error" v-else-if="whisper.status === 'error'">Error</span>
					<span class="transcript-badge" v-else>Idle</span>
				</div>
				<div class="transcript-controls">
					<select v-model="whisper.model" :disabled="whisper.active" class="transcript-select" title="Whisper model">
						<option value="onnx-community/whisper-tiny.en">Tiny.en (~40 MB)</option>
						<option value="onnx-community/whisper-base.en">Base.en (~75 MB)</option>
						<option value="onnx-community/whisper-small.en">Small.en (~250 MB)</option>
						<option value="onnx-community/whisper-tiny">Tiny multilingual</option>
						<option value="onnx-community/whisper-base">Base multilingual</option>
					</select>
					<select v-model.number="whisper.chunkSeconds" :disabled="whisper.active" class="transcript-select" title="Chunk length (seconds)">
						<option :value="3">3 s</option>
						<option :value="5">5 s</option>
						<option :value="10">10 s</option>
						<option :value="15">15 s</option>
					</select>
					<button class="btn transcript-btn" :class="{ 'btn-primary': !whisper.active, 'btn-stop': whisper.active }" @click="toggleWhisper" :disabled="!running">
						{{ whisper.active ? 'Stop' : 'Start' }}
					</button>
					<button class="btn transcript-btn" @click="clearTranscript" title="Clear log">Clear</button>
					<button class="btn transcript-btn" @click="exportTranscript" title="Export as text" :disabled="whisper.log.length === 0">Export</button>
				</div>
			</div>
			<div class="transcript-body" ref="transcriptBody">
				<div v-if="whisper.log.length === 0" class="transcript-empty">
					No transcriptions yet. Start Whisper and tune to a voice transmission.
				</div>
				<div v-for="(entry, i) in whisper.log" :key="i" class="transcript-entry">
					<span class="transcript-time">{{ entry.time }}</span>
					<span class="transcript-freq">{{ entry.freq }}</span>
					<span class="transcript-text">{{ entry.text }}</span>
				</div>
			</div>
		</div>

		<!-- Dialogs -->
		<div class="snackbar" :class="{ show: snackbar.show }">{{ snackbar.message }}</div>
	</div>
</body>
</html>